

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>sbfit.profile &mdash; sbfit  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> sbfit
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../guide/installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../guide/installation.html#from-source">From source</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../guide/preparation.html">File preparation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../guide/preparation/image.html">Images</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../guide/preparation/image.html#image-types">Image types</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../guide/preparation/image.html#count-map">Count map</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../guide/preparation/image.html#exposure-map">Exposure map</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../guide/preparation/image.html#instrumental-background-map">Instrumental background map</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../guide/preparation/image.html#multiple-instruments-observations">Multiple instruments/observations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../guide/preparation/image.html#energy-range">Energy range</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../guide/preparation/region.html">Regions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../guide/preparation/region.html#region-format">Region format</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../guide/preparation/region.html#inclusive-regions">Inclusive regions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../guide/preparation/region.html#exclusive-regions">Exclusive regions</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../guide/usage.html">Usage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../guide/usage.html#load-data-and-extract-profiles">Load data and extract profiles</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../guide/usage.html#load-images">Load images</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../guide/usage.html#load-regions">Load regions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../guide/usage.html#extract-profiles">Extract profiles</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../guide/usage.html#model-fitting-and-visualization">Model fitting and visualization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../guide/usage.html#rebin">Rebin</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../guide/usage.html#display-a-profile">Display a profile</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../guide/usage.html#model-fitting">Model fitting</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../guide/usage.html#uncertainty-estimation-using-mcmc">Uncertainty estimation using MCMC</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../guide/usage.html#output-profiles">Output profiles</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../guide/model.html">Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide/concept.html">Basic Concepts</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../guide/concept/profile.html">Profiles</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../guide/concept/profile.html#channel-and-bin">Channel and bin</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../guide/concept/profile.html#profile-types">Profile types</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../guide/concept/profile.html#binning-methods">Binning methods</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../guide/concept/psf.html">PSF matrix</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../guide/concept/fit.html">Model fitting</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../sbfit.html">Reference/API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../sbfit.html#module-sbfit.image">sbfit.image</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../sbfit.html#module-sbfit.model">sbfit.model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../sbfit.html#module-sbfit.observation">sbfit.observation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../sbfit.html#module-sbfit.profile">sbfit.profile</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../sbfit.html#module-sbfit.region">sbfit.region</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../sbfit.html#module-sbfit.statistics">sbfit.statistics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../sbfit.html#module-sbfit.utils">sbfit.utils</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../acknowledgement.html">Acknowledgement</a></li>
</ul>
<p class="caption"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../example.html">Examples</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">sbfit</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>sbfit.profile</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for sbfit.profile</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module defines the profile class.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span><span class="p">,</span> <span class="n">optimize</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">modeling</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span> <span class="nn">astropy.convolution</span> <span class="kn">import</span> <span class="n">Model1DKernel</span><span class="p">,</span> <span class="n">Gaussian1DKernel</span><span class="p">,</span> <span class="n">convolve</span><span class="p">,</span> \
    <span class="n">Kernel</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="kn">import</span> <span class="n">NullFormatter</span>
<span class="kn">from</span> <span class="nn">matplotlib.gridspec</span> <span class="kn">import</span> <span class="n">GridSpec</span>
<span class="kn">import</span> <span class="nn">emcee</span>
<span class="kn">import</span> <span class="nn">corner</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">.statistics</span> <span class="kn">import</span> <span class="n">cstat</span>
<span class="kn">from</span> <span class="nn">.model</span> <span class="kn">import</span> <span class="n">BasicModel</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Profile&quot;</span><span class="p">]</span>


<div class="viewcode-block" id="Profile"><a class="viewcode-back" href="../../sbfit.html#sbfit.profile.Profile">[docs]</a><span class="k">class</span> <span class="nc">Profile</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The Profile class.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    raw_data : Table</span>
<span class="sd">        The raw table of data of individual pixels.</span>
<span class="sd">    channel_width : number, optional</span>
<span class="sd">        The width of each channel, which is the minimum unresolved size.</span>
<span class="sd">        The default channel_width = 1 arcsec.</span>
<span class="sd">    pixel_scale : number, optional</span>
<span class="sd">        The image pixel scale. The default pixel_scale = 0.01 degree.</span>
<span class="sd">    exposure_unit : Unit, optional</span>
<span class="sd">        The unit of the exposure map. The default exposure_unit = s.</span>
<span class="sd">    profile_axis : {&quot;x&quot;, &quot;y&quot;}, optional</span>
<span class="sd">        The type of the profile.</span>
<span class="sd">        &quot;x&quot;: radial profile with x-axis unit of arcsec.</span>
<span class="sd">        &quot;y&quot;: azimuthal profile with x-axis unit of degree.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_data</span><span class="p">:</span> <span class="n">Table</span><span class="p">,</span> <span class="n">channel_width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">channel_start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                 <span class="n">pixel_scale</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">exposure_unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">,</span> <span class="n">profile_axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_profile_axis</span> <span class="o">=</span> <span class="n">profile_axis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pixel_area</span> <span class="o">=</span> <span class="n">pixel_scale</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">3600</span>  <span class="c1"># arcmin^2 / pixel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_channel_width</span> <span class="o">=</span> <span class="n">channel_width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_channel_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">channel_start</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">])</span> <span class="o">+</span>
                                       <span class="n">channel_width</span><span class="p">,</span> <span class="n">channel_width</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_channel_center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_grid</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_smooth_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mat</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_channel_center</span><span class="o">.</span><span class="n">size</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_smooth_fwhm</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># in unit of grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_raw_profile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_channel</span><span class="p">(</span><span class="n">raw_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_grid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bin_grid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mcmc_sampler</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mcmc_flat_samples</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_error</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_show_stat</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_min_stat</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_error_approx</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exposure_unit</span> <span class="o">=</span> <span class="n">exposure_unit</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">channel_width</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The width of each channel. A channel is the smallest discrete element</span>
<span class="sd">        of the profile.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_width</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The model of the profile.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span>

    <span class="nd">@model</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_model</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_model</span><span class="p">,</span> <span class="p">(</span><span class="n">BasicModel</span><span class="p">,</span> <span class="n">modeling</span><span class="o">.</span><span class="n">CompoundModel</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">new_model</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The input must be a model object&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The error estimated by the MCMC method.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_error</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">error_approx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The approximate error from the fit routine.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_error_approx</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">binned_profile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The binned surface brightness profile.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mcmc_flat_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mcmc_flat_samples</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_create_channel</span><span class="p">(</span><span class="n">raw_data</span><span class="p">,</span> <span class="n">bin_grid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the raw profile during initialization.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        raw_data : Table</span>
<span class="sd">            The raw table of data of individual pixels.</span>
<span class="sd">        bin_grid : ndarray</span>
<span class="sd">            The bin grid to create the raw profile.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        raw_profile : Table</span>
<span class="sd">            The binned raw profile.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">r</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">bin_grid</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bin_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="n">cts_binned</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">binned_statistic</span><span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">],</span>
                                                  <span class="n">raw_data</span><span class="p">[</span><span class="s2">&quot;cts&quot;</span><span class="p">],</span>
                                                  <span class="n">statistic</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span>
                                                  <span class="n">bins</span><span class="o">=</span><span class="n">bin_grid</span><span class="p">)</span>
        <span class="n">exp_binned</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">binned_statistic</span><span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">],</span>
                                                  <span class="n">raw_data</span><span class="p">[</span><span class="s2">&quot;exp&quot;</span><span class="p">],</span>
                                                  <span class="n">statistic</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span>
                                                  <span class="n">bins</span><span class="o">=</span><span class="n">bin_grid</span><span class="p">)</span>
        <span class="n">raw_bkg_binned</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">binned_statistic</span><span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">],</span>
                                                      <span class="n">raw_data</span><span class="p">[</span><span class="s2">&quot;raw_bkg&quot;</span><span class="p">],</span>
                                                      <span class="n">statistic</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span>
                                                      <span class="n">bins</span><span class="o">=</span><span class="n">bin_grid</span><span class="p">)</span>
        <span class="n">scaled_bkg_binned</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">binned_statistic</span><span class="p">(</span><span class="n">raw_data</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">],</span>
                                                         <span class="n">raw_data</span><span class="p">[</span>
                                                             <span class="s2">&quot;scaled_bkg&quot;</span><span class="p">],</span>
                                                         <span class="n">statistic</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span>
                                                         <span class="n">bins</span><span class="o">=</span><span class="n">bin_grid</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Table</span><span class="p">(</span>
            <span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">cts_binned</span><span class="p">,</span> <span class="n">exp_binned</span><span class="p">,</span> <span class="n">raw_bkg_binned</span><span class="p">,</span> <span class="n">scaled_bkg_binned</span><span class="p">,</span>
             <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">r</span><span class="p">),</span>
             <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">r</span><span class="p">)],</span>
            <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;cts&quot;</span><span class="p">,</span> <span class="s2">&quot;exp&quot;</span><span class="p">,</span> <span class="s2">&quot;raw_bkg&quot;</span><span class="p">,</span> <span class="s2">&quot;scaled_bkg&quot;</span><span class="p">,</span> <span class="s2">&quot;model_cts&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;bin_num&quot;</span><span class="p">),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">))</span>

<div class="viewcode-block" id="Profile.deepcopy"><a class="viewcode-back" href="../../sbfit.html#sbfit.profile.Profile.deepcopy">[docs]</a>    <span class="k">def</span> <span class="nf">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        To create a deepcopy of the profile.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        profile : Profile</span>
<span class="sd">            A deepcopy of the profile itself.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="Profile.rebin"><a class="viewcode-back" href="../../sbfit.html#sbfit.profile.Profile.rebin">[docs]</a>    <span class="k">def</span> <span class="nf">rebin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;min_cts&quot;</span><span class="p">,</span> <span class="n">min_cts</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
              <span class="n">lin_width</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">log_width</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rebin the profile from the raw profile.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        start : float</span>
<span class="sd">            Start point of the profile.</span>
<span class="sd">        end : float</span>
<span class="sd">            End point of the profile. Depending on different methods, the</span>
<span class="sd">            actual boundary of the last bin can be different from this value.</span>
<span class="sd">        method : {&quot;min_cts&quot;, &quot;lin&quot;, &quot;log&quot;}, optional</span>
<span class="sd">            The method to bin the profile.</span>
<span class="sd">            &quot;min_cts&quot; : each bin has at least a certain number of counts.</span>
<span class="sd">            &quot;lin&quot; : each bin has the same width.</span>
<span class="sd">            &quot;log&quot; : each bin has the same width in the logarithmic space.</span>
<span class="sd">            The default method = &quot;min_cts&quot;.</span>
<span class="sd">        min_cts : int, optional</span>
<span class="sd">            The minimum count number in each of the bins. Used if</span>
<span class="sd">            method == &quot;min_cts&quot;. The default min_cts = 30.</span>
<span class="sd">        lin_width : float, optional</span>
<span class="sd">            The width of each bin. Used if method == &quot;lin_width&quot;. The default</span>
<span class="sd">            lin_width = 10 arcsec.</span>
<span class="sd">        log_width : float, optional</span>
<span class="sd">            The width of each bin in the logarithmic space, in unit of dex.</span>
<span class="sd">            Used if method == &quot;log_width&quot;. The default log_width = 0.05.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># set the end of profile</span>
        <span class="k">if</span> <span class="n">end</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_raw_profile</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">]):</span>
            <span class="n">bin_end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_raw_profile</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bin_end</span> <span class="o">=</span> <span class="n">end</span>

        <span class="c1"># build bin grids for the specific method</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;min_cts&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">min_cts</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;need at least one count per bin.&quot;</span><span class="p">)</span>
            <span class="n">valid_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_profile</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">start</span>
            <span class="n">bin_grid_loc_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_raw_profile</span><span class="p">[</span><span class="s2">&quot;cts&quot;</span><span class="p">][</span><span class="n">valid_range</span><span class="p">])</span> <span class="o">//</span> <span class="n">min_cts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span>

            <span class="n">bin_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">start</span><span class="p">]),</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">_raw_profile</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">][</span><span class="n">valid_range</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span>
                                     <span class="n">bin_grid_loc_mask</span><span class="p">])</span>
            <span class="n">bin_grid</span> <span class="o">=</span> <span class="n">bin_grid</span><span class="p">[</span><span class="n">bin_grid</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bin_grid</span> <span class="o">=</span> <span class="n">bin_grid</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;lin&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bin_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">bin_end</span> <span class="o">+</span> <span class="n">lin_width</span><span class="p">,</span> <span class="n">lin_width</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;log&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">log_width</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;log_width must larger than 0&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log_bin_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">start</span><span class="p">),</span>
                                         <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">bin_end</span><span class="p">)</span> <span class="o">+</span> <span class="n">log_width</span><span class="p">,</span>
                                         <span class="n">log_width</span><span class="p">)</span>
                <span class="n">bin_grid</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">log_bin_grid</span>
                <span class="n">pop_num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">bin_grid</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_bin_grid</span> <span class="o">=</span> <span class="n">bin_grid</span><span class="p">[</span><span class="n">pop_num</span><span class="p">:]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_binning</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_binning</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A wrapper of the binning procedures.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bin_center</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bin_grid</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bin_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

        <span class="n">cts_binned</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">bin_num</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">binned_statistic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_raw_profile</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">],</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">_raw_profile</span><span class="p">[</span>
                                                            <span class="s2">&quot;cts&quot;</span><span class="p">],</span>
                                                        <span class="n">statistic</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span>
                                                        <span class="n">bins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_bin_grid</span><span class="p">)</span>
        <span class="n">exp_binned</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">binned_statistic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_raw_profile</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">],</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">_raw_profile</span><span class="p">[</span><span class="s2">&quot;exp&quot;</span><span class="p">],</span>
                                                  <span class="n">statistic</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span>
                                                  <span class="n">bins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_bin_grid</span><span class="p">)</span>
        <span class="n">raw_bkg_binned</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">binned_statistic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_raw_profile</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">],</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">_raw_profile</span><span class="p">[</span>
                                                          <span class="s2">&quot;raw_bkg&quot;</span><span class="p">],</span>
                                                      <span class="n">statistic</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span>
                                                      <span class="n">bins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_bin_grid</span><span class="p">)</span>
        <span class="n">scaled_bkg_binned</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">binned_statistic</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raw_profile</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raw_profile</span><span class="p">[</span>
                <span class="s2">&quot;scaled_bkg&quot;</span><span class="p">],</span>
            <span class="n">statistic</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span>
            <span class="n">bins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_bin_grid</span><span class="p">)</span>
        <span class="n">model_cts_binned</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">binned_statistic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_raw_profile</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">],</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">_raw_profile</span><span class="p">[</span>
                                                            <span class="s2">&quot;model_cts&quot;</span><span class="p">],</span>
                                                        <span class="n">statistic</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span>
                                                        <span class="n">bins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_bin_grid</span><span class="p">)</span>
        <span class="n">model_sb</span> <span class="o">=</span> <span class="n">model_cts_binned</span> <span class="o">/</span> <span class="n">exp_binned</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pixel_area</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_raw_profile</span><span class="p">[</span><span class="s2">&quot;bin_num&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bin_num</span>

        <span class="n">norm_bkg_binned</span> <span class="o">=</span> <span class="n">scaled_bkg_binned</span> <span class="o">/</span> <span class="n">raw_bkg_binned</span>
        <span class="n">norm_bkg_binned</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">norm_bkg_binned</span><span class="p">,</span> <span class="n">posinf</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">neginf</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pseudo_bkgsb</span> <span class="o">=</span> <span class="n">scaled_bkg_binned</span> <span class="o">/</span> <span class="n">exp_binned</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pixel_area</span>
        <span class="n">pseudo_bkgsb_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="n">raw_bkg_binned</span><span class="p">)</span> <span class="o">*</span> <span class="n">norm_bkg_binned</span> <span class="o">/</span> <span class="n">exp_binned</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pixel_area</span>
        <span class="n">net_cts_binned</span> <span class="o">=</span> <span class="n">cts_binned</span> <span class="o">-</span> <span class="n">scaled_bkg_binned</span>
        <span class="n">sb_binned</span> <span class="o">=</span> <span class="n">net_cts_binned</span> <span class="o">/</span> <span class="n">exp_binned</span> \
                    <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pixel_area</span>  <span class="c1"># surface brightness</span>
        <span class="n">sb_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="n">cts_binned</span> <span class="o">+</span> <span class="n">raw_bkg_binned</span> <span class="o">*</span> <span class="n">norm_bkg_binned</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="p">)</span> <span class="o">/</span> <span class="n">exp_binned</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pixel_area</span>
        <span class="n">r_error_left</span> <span class="o">=</span> <span class="n">bin_center</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bin_grid</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">r_error_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bin_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">bin_center</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
            <span class="p">[</span><span class="n">bin_center</span><span class="p">,</span> <span class="n">r_error_left</span><span class="p">,</span> <span class="n">r_error_right</span><span class="p">,</span> <span class="n">sb_binned</span><span class="p">,</span> <span class="n">sb_error</span><span class="p">,</span>
             <span class="n">pseudo_bkgsb</span><span class="p">,</span>
             <span class="n">pseudo_bkgsb_error</span><span class="p">,</span> <span class="n">model_sb</span><span class="p">,</span> <span class="n">cts_binned</span><span class="p">,</span> <span class="n">scaled_bkg_binned</span><span class="p">],</span>
            <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;r_error_left&quot;</span><span class="p">,</span> <span class="s2">&quot;r_error_right&quot;</span><span class="p">,</span> <span class="s2">&quot;sb&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;sb_error&quot;</span><span class="p">,</span> <span class="s2">&quot;bkg_sb&quot;</span><span class="p">,</span> <span class="s2">&quot;bkg_sb_error&quot;</span><span class="p">,</span> <span class="s2">&quot;model_sb&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;total_cts&quot;</span><span class="p">,</span> <span class="s2">&quot;bkg_cts&quot;</span><span class="p">),</span>
            <span class="n">dtype</span><span class="o">=</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span>
                   <span class="nb">float</span><span class="p">))</span>

<div class="viewcode-block" id="Profile.set_model"><a class="viewcode-back" href="../../sbfit.html#sbfit.profile.Profile.set_model">[docs]</a>    <span class="k">def</span> <span class="nf">set_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">modeling</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set model for the Profile object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model : Model</span>
<span class="sd">            The model used for fit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span></div>

<div class="viewcode-block" id="Profile.calculate"><a class="viewcode-back" href="../../sbfit.html#sbfit.profile.Profile.calculate">[docs]</a>    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the C-statistic value for the current model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        update : bool, optional</span>
<span class="sd">            Update the model profile, default = True.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        stat_value : float</span>
<span class="sd">            The calculated C-statistic value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="ne">Warning</span><span class="p">(</span><span class="s2">&quot;No model found&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="ne">Warning</span><span class="p">(</span><span class="s2">&quot;Rebin the profile first.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span> <span class="n">modeling</span><span class="o">.</span><span class="n">Model</span>
            <span class="n">valid_range_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bin_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> \
                                <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smooth_fwhm</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_width</span>
            <span class="n">valid_range_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bin_grid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> \
                              <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smooth_fwhm</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_width</span>
            <span class="n">valid_grid_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_raw_profile</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">valid_range_end</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_raw_profile</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">valid_range_start</span><span class="p">)</span>
            <span class="n">valid_channel_center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_center</span><span class="p">[</span><span class="n">valid_grid_mask</span><span class="p">]</span>

            <span class="n">model_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">valid_channel_center</span><span class="p">,</span>
                                              <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
            <span class="n">total_model_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_channel_center</span><span class="p">)</span>
            <span class="n">total_model_value</span><span class="p">[</span><span class="n">valid_grid_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_value</span>
            <span class="n">smoothed_model_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_smooth_matrix</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mat</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">total_model_value</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">smoothed_model_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">smoothed_model_value</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">smoothed_model_cts</span> <span class="o">=</span> <span class="n">smoothed_model_value</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_profile</span><span class="p">[</span>
                <span class="s2">&quot;exp&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pixel_area</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raw_profile</span><span class="o">.</span><span class="n">replace_column</span><span class="p">(</span><span class="s2">&quot;model_cts&quot;</span><span class="p">,</span> <span class="n">smoothed_model_cts</span><span class="p">)</span>

            <span class="n">model_cts_binned</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">binned_statistic</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_raw_profile</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_profile</span><span class="p">[</span><span class="s2">&quot;model_cts&quot;</span><span class="p">],</span>
                <span class="n">statistic</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_bin_grid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">update</span><span class="p">:</span>
                <span class="c1"># update binned profile</span>
                <span class="n">exp_binned</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">binned_statistic</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_raw_profile</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_profile</span><span class="p">[</span><span class="s2">&quot;exp&quot;</span><span class="p">],</span>
                    <span class="n">statistic</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_bin_grid</span><span class="p">)</span>
                <span class="n">model_sb_binned</span> <span class="o">=</span> <span class="n">model_cts_binned</span> <span class="o">/</span> <span class="n">exp_binned</span> \
                                  <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pixel_area</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="o">.</span><span class="n">replace_column</span><span class="p">(</span><span class="s2">&quot;model_sb&quot;</span><span class="p">,</span>
                                                    <span class="n">model_sb_binned</span><span class="p">,</span> <span class="p">)</span>

            <span class="c1"># calculate residual</span>
            <span class="n">model_total_cts</span> <span class="o">=</span> <span class="n">model_cts_binned</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">[</span>
                <span class="s2">&quot;bkg_cts&quot;</span><span class="p">]</span>
            <span class="n">stat_value</span> <span class="o">=</span> <span class="n">cstat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">[</span><span class="s2">&quot;total_cts&quot;</span><span class="p">],</span>
                               <span class="n">model_total_cts</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_show_stat</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;C-stat: </span><span class="si">{</span><span class="n">stat_value</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">stat_value</span></div>

<div class="viewcode-block" id="Profile.set_smooth_matrix"><a class="viewcode-back" href="../../sbfit.html#sbfit.profile.Profile.set_smooth_matrix">[docs]</a>    <span class="k">def</span> <span class="nf">set_smooth_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kernel_type</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">king_rc</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                          <span class="n">king_alpha</span><span class="o">=</span><span class="mf">1.4</span><span class="p">,</span> <span class="n">custom_kernel</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the smoothing matrix for the profile to account for the PSF of the</span>
<span class="sd">        telescope.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        kernel_type : {&quot;identity&quot;, &quot;gaussian&quot;, &quot;king&quot;, &quot;custom&quot;}</span>
<span class="sd">            Type of the PSF kernel.</span>
<span class="sd">            &quot;identity&quot;: Identity matrix.</span>
<span class="sd">            &quot;gaussian&quot;: Gaussian profile.</span>
<span class="sd">            &quot;king&quot;: King profile.</span>
<span class="sd">            &quot;custom&quot;: User defined kernel.</span>
<span class="sd">            The default kernel_type = &quot;identity&quot;.</span>
<span class="sd">        sigma : number, optional</span>
<span class="sd">            The sigma of Gaussian kernel. The default sigma = 1 arcsec.</span>
<span class="sd">        king_rc : number, optional</span>
<span class="sd">            The core radius of the king profile.</span>
<span class="sd">        king_alpha : number, optional</span>
<span class="sd">            The power law index of the king profile. The default</span>
<span class="sd">            king_alpha=1.4.</span>
<span class="sd">        custom_kernel : Kernel, optional</span>
<span class="sd">            The customized smoothing kernel.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_channel</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_channel_center</span><span class="p">)</span>

        <span class="n">smooth_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_channel</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">kernel_type</span> <span class="o">==</span> <span class="s2">&quot;identity&quot;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># set model</span>
            <span class="k">if</span> <span class="n">kernel_type</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>
                <span class="n">psf_kernel</span> <span class="o">=</span> <span class="n">Gaussian1DKernel</span><span class="p">(</span><span class="n">sigma</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_width</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_smooth_fwhm</span> <span class="o">=</span> <span class="mf">2.355</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_width</span>
            <span class="k">elif</span> <span class="n">kernel_type</span> <span class="o">==</span> <span class="s2">&quot;king&quot;</span><span class="p">:</span>
                <span class="n">psf_model</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">King</span><span class="p">(</span><span class="n">rc</span><span class="o">=</span><span class="n">king_rc</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_width</span><span class="p">,</span>
                                       <span class="n">alpha</span><span class="o">=</span><span class="n">king_alpha</span><span class="p">)</span>
                <span class="n">psf_kernel</span> <span class="o">=</span> <span class="n">Model1DKernel</span><span class="p">(</span>
                    <span class="n">psf_model</span><span class="p">,</span>
                    <span class="n">x_size</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">king_rc</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_width</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_smooth_fwhm</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">king_rc</span> <span class="o">*</span> \
                                    <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="p">(</span>
                                            <span class="mi">1</span> <span class="o">/</span> <span class="n">king_alpha</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_width</span>
            <span class="k">elif</span> <span class="n">kernel_type</span> <span class="o">==</span> <span class="s2">&quot;custom&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">custom_kernel</span><span class="p">,</span> <span class="n">Kernel</span><span class="p">):</span>
                    <span class="n">psf_kernel</span> <span class="o">=</span> <span class="n">custom_kernel</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The custom_kernle must be a &quot;</span>
                                    <span class="s2">&quot;Kernel object&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The kernel_type must be in {&#39;gaussian&#39;, &quot;</span>
                                 <span class="s2">&quot;&#39;king&#39;, &#39;custom&#39;}.&quot;</span><span class="p">)</span>

            <span class="c1"># create convolve matrix from the 2D array</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_channel</span><span class="p">):</span>
                <span class="n">smooth_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">convolve</span><span class="p">(</span><span class="n">smooth_array</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">psf_kernel</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_smooth_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mat</span><span class="p">(</span><span class="n">smooth_array</span><span class="p">)</span><span class="o">.</span><span class="n">T</span></div>

<div class="viewcode-block" id="Profile.plot"><a class="viewcode-back" href="../../sbfit.html#sbfit.profile.Profile.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot_type</span><span class="o">=</span><span class="s2">&quot;profile&quot;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;loglog&quot;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        To show different types of data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        plot_type : {&quot;profile&quot;, &quot;mcmc_chain&quot;, &quot;contour&quot;}, optional</span>
<span class="sd">            Types of plot.</span>
<span class="sd">            &quot;profile&quot; : The binned surface brightness profile.</span>
<span class="sd">            &quot;mcmc_chain&quot; : The MCMC chain of each free parameter after</span>
<span class="sd">            estimating the errors.</span>
<span class="sd">            &quot;contour&quot; : The &quot;corner&quot; plot of free parameters after estimating</span>
<span class="sd">            the errors.</span>
<span class="sd">            The default plot_type = &quot;profile&quot;.</span>
<span class="sd">        scale : {&quot;loglog&quot;, &quot;semilogx&quot;, &quot;semilogy&quot;, &quot;linear&quot;}, optional</span>
<span class="sd">            The X-Y axis scale of the profile plot.</span>
<span class="sd">            The default scale = &quot;loglog&quot;.</span>
<span class="sd">        xlim : tuple, optional</span>
<span class="sd">            The X-axis limits of the profile.</span>
<span class="sd">        ylim : tuple, optional</span>
<span class="sd">            The Y-axis limits of the profile.</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s2">&quot;profile&quot;</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Figure</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
            <span class="n">grid_spec</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                                 <span class="n">height_ratios</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="c1"># ax_profile: plt.Axes = fig.gca()</span>
            <span class="n">ax_profile</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">grid_spec</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
            <span class="n">ax_chi</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">grid_spec</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>

            <span class="c1"># plot the profile</span>
            <span class="n">ax_profile</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">],</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">[</span><span class="s2">&quot;sb&quot;</span><span class="p">],</span>
                                <span class="n">xerr</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">[</span><span class="s2">&quot;r_error_right&quot;</span><span class="p">],</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">[</span><span class="s2">&quot;r_error_left&quot;</span><span class="p">]),</span>
                                <span class="n">yerr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">[</span><span class="s2">&quot;sb_error&quot;</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:blue&quot;</span><span class="p">)</span>
            <span class="n">ax_profile</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">[</span>
                    <span class="s2">&quot;r_error_left&quot;</span><span class="p">],</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">[</span><span class="s2">&quot;r_error_right&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">[</span><span class="s2">&quot;bkg_sb&quot;</span><span class="p">],</span>
                          <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">[</span><span class="s2">&quot;bkg_sb&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])),</span>
                <span class="n">where</span><span class="o">=</span><span class="s2">&quot;post&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;background&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:green&quot;</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
            <span class="n">ax_profile</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">[</span>
                    <span class="s2">&quot;r_error_left&quot;</span><span class="p">],</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">[</span><span class="s2">&quot;r_error_right&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">[</span><span class="s2">&quot;bkg_sb&quot;</span><span class="p">]</span> <span class="o">-</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">[</span><span class="s2">&quot;bkg_sb_error&quot;</span><span class="p">],</span>
                          <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">[</span><span class="s2">&quot;bkg_sb&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">[</span><span class="s2">&quot;bkg_sb_error&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">[</span><span class="s2">&quot;bkg_sb&quot;</span><span class="p">]</span> <span class="o">+</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">[</span><span class="s2">&quot;bkg_sb_error&quot;</span><span class="p">],</span>
                          <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">[</span><span class="s2">&quot;bkg_sb&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">[</span><span class="s2">&quot;bkg_sb_error&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                <span class="n">step</span><span class="o">=</span><span class="s2">&quot;post&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:green&quot;</span><span class="p">)</span>
            <span class="n">ax_profile</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">]</span> <span class="o">-</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">[</span><span class="s2">&quot;r_error_left&quot;</span><span class="p">],</span>
                                      <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">[</span>
                                                   <span class="s2">&quot;r_error_right&quot;</span><span class="p">][</span>
                                                   <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                               <span class="p">)),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">[</span><span class="s2">&quot;model_sb&quot;</span><span class="p">],</span>
                                      <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">[</span><span class="s2">&quot;model_sb&quot;</span><span class="p">][</span>
                                              <span class="o">-</span><span class="mi">1</span><span class="p">])),</span>
                            <span class="n">where</span><span class="o">=</span><span class="s2">&quot;post&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:orange&quot;</span><span class="p">)</span>

            <span class="c1"># plot chi</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No model set.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax_chi</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">],</span>
                                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">[</span><span class="s2">&quot;sb&quot;</span><span class="p">]</span> <span class="o">-</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">[</span><span class="s2">&quot;model_sb&quot;</span><span class="p">])</span> <span class="o">/</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">[</span><span class="s2">&quot;sb_error&quot;</span><span class="p">],</span>
                                <span class="n">xerr</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">[</span><span class="s2">&quot;r_error_right&quot;</span><span class="p">],</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">[</span><span class="s2">&quot;r_error_left&quot;</span><span class="p">]),</span>
                                <span class="n">yerr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">]),</span>
                                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:blue&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
                                <span class="p">)</span>
                <span class="n">ax_chi</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
                              <span class="n">xmin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">[</span><span class="s2">&quot;r_error_left&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                              <span class="n">xmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">[</span><span class="s2">&quot;r_error_right&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                              <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;tab:orange&quot;</span><span class="p">,</span> <span class="n">linestyles</span><span class="o">=</span><span class="s2">&quot;dashed&quot;</span>
                              <span class="p">)</span>

            <span class="c1"># scale</span>
            <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="s2">&quot;loglog&quot;</span><span class="p">:</span>
                <span class="n">ax_profile</span><span class="o">.</span><span class="n">loglog</span><span class="p">()</span>
                <span class="n">ax_chi</span><span class="o">.</span><span class="n">semilogx</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">scale</span> <span class="o">==</span> <span class="s2">&quot;semilogx&quot;</span><span class="p">:</span>
                <span class="n">ax_profile</span><span class="o">.</span><span class="n">semilogx</span><span class="p">()</span>
                <span class="n">ax_chi</span><span class="o">.</span><span class="n">semilogx</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">scale</span> <span class="o">==</span> <span class="s2">&quot;semilogy&quot;</span><span class="p">:</span>
                <span class="n">ax_profile</span><span class="o">.</span><span class="n">semilogy</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">scale</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Scale must be one of {&#39;linear&#39;, &#39;loglog&#39;,&quot;</span>
                                 <span class="s2">&quot;&#39;semilogx&#39;, &#39;semilogy&#39;}.&quot;</span><span class="p">)</span>

            <span class="c1"># limits</span>
            <span class="k">if</span> <span class="n">xlim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax_profile</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">*</span><span class="n">xlim</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">if</span> <span class="n">ylim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax_profile</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">*</span><span class="n">ylim</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="n">ax_chi</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="n">xlim_profile</span> <span class="o">=</span> <span class="n">ax_profile</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
            <span class="n">ax_chi</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">*</span><span class="n">xlim_profile</span><span class="p">)</span>

            <span class="c1"># ticklables</span>
            <span class="n">ax_profile</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">NullFormatter</span><span class="p">())</span>
            <span class="n">ax_profile</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_formatter</span><span class="p">(</span><span class="n">NullFormatter</span><span class="p">())</span>

            <span class="c1"># x-axis unit</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_profile_axis</span> <span class="o">==</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span>
                <span class="n">ax_chi</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;r (arcsec)&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_profile_axis</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span>
                <span class="n">ax_chi</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;$</span><span class="se">\\</span><span class="s2">theta$ (degree)&quot;</span><span class="p">)</span>
            <span class="n">ylabel_unit</span> <span class="o">=</span> \
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">u</span><span class="o">.</span><span class="n">count</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">arcmin</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exposure_unit</span><span class="si">:</span><span class="s2">latex_inline</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">ax_profile</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SB (</span><span class="si">{</span><span class="n">ylabel_unit</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="n">ax_chi</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$</span><span class="se">\\</span><span class="s2">chi$&quot;</span><span class="p">)</span>

            <span class="n">ax_profile</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s2">&quot;mcmc_chain&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mcmc_sampler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No sampler found, please run mcmc_error first.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">samples</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mcmc_sampler</span><span class="o">.</span><span class="n">get_chain</span><span class="p">()</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
                                         <span class="n">sharex</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
                <span class="n">labels</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_free_parameter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">ax_profile</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">ax_profile</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">samples</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
                    <span class="n">ax_profile</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">))</span>
                    <span class="n">ax_profile</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">ax_profile</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_label_coords</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>

                <span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;step number&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s2">&quot;contour&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mcmc_sampler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No sampler found, please run mcmc_error first.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pnames_free</span><span class="p">,</span> <span class="n">pvalues_free</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_free_parameter</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">corner</span><span class="o">.</span><span class="n">corner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mcmc_flat_samples</span><span class="p">,</span>
                                    <span class="n">smooth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">smooth1d</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                    <span class="n">bins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mcmc_flat_samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span>
                                             <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2000</span><span class="p">,</span>
                                    <span class="n">truths</span><span class="o">=</span><span class="n">pvalues_free</span><span class="p">,</span>
                                    <span class="n">labels</span><span class="o">=</span><span class="n">pnames_free</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span></div>

<div class="viewcode-block" id="Profile.fit"><a class="viewcode-back" href="../../sbfit.html#sbfit.profile.Profile.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">show_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show_result</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">record_fit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">tolerance</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit binned profile with the model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        show_step : bool, optional</span>
<span class="sd">            Whether show C-statistic value of each fit step.</span>
<span class="sd">        show_result : bool, optional</span>
<span class="sd">            Whether show fit result.</span>
<span class="sd">        record_fit : bool, optional</span>
<span class="sd">            Whether record the fit result in the Profile object.</span>
<span class="sd">        tolerance : float, optional</span>
<span class="sd">            Tolerance to terminate the fit iteration.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        stat : float</span>
<span class="sd">            The best-fit C-statistic value.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="ne">Warning</span><span class="p">(</span><span class="s2">&quot;No model found&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span> <span class="n">modeling</span><span class="o">.</span><span class="n">Model</span>

            <span class="c1"># fit</span>
            <span class="n">stat</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_wrapper</span><span class="p">(</span><span class="n">tol</span><span class="o">=</span><span class="n">tolerance</span><span class="p">,</span> <span class="n">show_step</span><span class="o">=</span><span class="n">show_step</span><span class="p">)</span>

            <span class="n">pnames_free</span><span class="p">,</span> <span class="n">pvalues_free</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_free_parameter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
            <span class="n">dof</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">pnames_free</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">show_result</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Degree of freedom: </span><span class="si">{</span><span class="n">dof</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">; C-stat: </span><span class="si">{</span><span class="n">stat</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">pnames_free</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2">:</span><span class="se">\t</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Uncertainties from rough estimation:&quot;</span><span class="p">)</span>
                <span class="p">[</span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pnames_free</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="se">\t</span><span class="si">{</span><span class="n">error</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>
                 <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pnames_free</span><span class="p">))]</span>
            <span class="k">if</span> <span class="n">record_fit</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_min_stat</span> <span class="o">=</span> <span class="n">stat</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_error_approx</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">pnames_free</span><span class="p">,</span>
                                                                 <span class="n">error</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">stat</span></div>

    <span class="k">def</span> <span class="nf">_fit_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span> <span class="n">show_step</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nfail</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit routine using a Levenberg-Marquardt optimizer.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tol : float, optional</span>
<span class="sd">            Tolerance to terminate the fit iteration.</span>
<span class="sd">        show_step : float, optional</span>
<span class="sd">            Whether show C-statistic value of each fit step.</span>
<span class="sd">        nfail : int, optional</span>
<span class="sd">            The number of iteration before decreasing the statistics.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        stat : float, optional</span>
<span class="sd">            The best-fit C-statistic value.</span>
<span class="sd">        errors : numpy.ndarray</span>
<span class="sd">            A rough estimation of the errors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pnames_free</span><span class="p">,</span> <span class="n">pvalues_free</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_free_parameter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="n">pvalues_free</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pvalues_free</span><span class="p">)</span>
        <span class="n">low_bounds</span><span class="p">,</span> <span class="n">up_bounds</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_parameter_bounds</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                                                           <span class="n">pnames_free</span><span class="p">)</span>
        <span class="n">damp_factor</span> <span class="o">=</span> <span class="mf">1e-4</span>
        <span class="n">dstat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">stat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">update</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show_step</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Start fit</span><span class="se">\n</span><span class="s2">C-stat: </span><span class="si">{</span><span class="n">stat</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">pvalues_free</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">fail</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="n">dstat</span> <span class="o">&gt;</span> <span class="n">tol</span> <span class="ow">and</span> <span class="n">fail</span> <span class="o">&lt;=</span> <span class="n">nfail</span><span class="p">:</span>
            <span class="c1"># calculate delta parameter</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stat_deriv_matrix</span><span class="p">()</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_stat_deriv</span><span class="p">())</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>  <span class="c1"># Eq. 15.5.8 Numerical Recipes 3rd</span>
            <span class="n">modified_alpha</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">alpha</span><span class="p">))</span> <span class="o">*</span> <span class="n">damp_factor</span>  <span class="c1"># Eq. 15.5.13</span>
            <span class="n">shift</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span>
                <span class="n">modified_alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">beta</span>  <span class="c1"># Eq. 15.5.14</span>
            <span class="c1"># shift = np.array(shift).flatten()</span>
            <span class="n">new_pvalues_free</span> <span class="o">=</span> <span class="n">pvalues_free</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shift</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

            <span class="c1"># check if new parameter vales reach the boundaries</span>
            <span class="n">up_mask</span> <span class="o">=</span> <span class="n">new_pvalues_free</span> <span class="o">&gt;</span> <span class="n">up_bounds</span>
            <span class="n">new_pvalues_free</span><span class="p">[</span><span class="n">up_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">up_bounds</span><span class="p">[</span><span class="n">up_mask</span><span class="p">]</span>
            <span class="n">low_mask</span> <span class="o">=</span> <span class="n">new_pvalues_free</span> <span class="o">&lt;</span> <span class="n">low_bounds</span>
            <span class="n">new_pvalues_free</span><span class="p">[</span><span class="n">low_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">low_bounds</span><span class="p">[</span><span class="n">low_mask</span><span class="p">]</span>

            <span class="c1"># set new parameter values</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pnames_free</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">pnames_free</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">new_pvalues_free</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">new_stat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">update</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">stat</span> <span class="o">-</span> <span class="n">new_stat</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># new stat &gt; current stat</span>
                <span class="n">damp_factor</span> <span class="o">*=</span> <span class="mi">100</span>
                <span class="n">fail</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pnames_free</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">pnames_free</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pvalues_free</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># new stat &lt; current stat</span>
                <span class="n">dstat</span> <span class="o">=</span> <span class="n">stat</span> <span class="o">-</span> <span class="n">new_stat</span>
                <span class="n">damp_factor</span> <span class="o">/=</span> <span class="mi">5</span>
                <span class="n">fail</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">stat</span> <span class="o">=</span> <span class="n">new_stat</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">pvalues_free</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_free_parameter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">show_step</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;C-stat: </span><span class="si">{</span><span class="n">new_stat</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">new_pvalues_free</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="n">stat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">show_step</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Iteration terminated.&quot;</span><span class="p">)</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span><span class="o">.</span><span class="n">diagonal</span><span class="p">())))</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">stat</span><span class="p">,</span> <span class="n">errors</span>

    <span class="k">def</span> <span class="nf">_stat_deriv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pnames</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the first derivative of the statistic value versus each</span>
<span class="sd">        parameter.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pnames : list, optional</span>
<span class="sd">            If set, only calculate the first derivative versus the given</span>
<span class="sd">            parameter.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        deriv : ndarray</span>
<span class="sd">            The array of calculated derivatives.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pnames_free</span><span class="p">,</span> <span class="n">pvalues_free</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_free_parameter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="n">current_model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="mf">1e-4</span>
        <span class="c1"># calculate derivative for each parameter</span>
        <span class="n">deriv</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pnames_deriv</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pvalues_deriv</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">pnames</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">pnames</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pnames_free</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> is not a free parameter.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="n">pnames_free</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">pnames_deriv</span> <span class="o">+=</span> <span class="p">[</span><span class="n">pnames_free</span><span class="p">[</span><span class="n">index</span><span class="p">]]</span>
                    <span class="n">pvalues_deriv</span> <span class="o">+=</span> <span class="p">[</span><span class="n">pvalues_free</span><span class="p">[</span><span class="n">index</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pnames_deriv</span> <span class="o">=</span> <span class="n">pnames_free</span>
            <span class="n">pvalues_deriv</span> <span class="o">=</span> <span class="n">pvalues_free</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pnames_deriv</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">pnames_deriv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pvalues_deriv</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">stat0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">update</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">pnames_deriv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                   <span class="mf">1e-10</span> <span class="o">+</span> <span class="n">pvalues_deriv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">shift</span><span class="p">))</span>
            <span class="n">stat1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">update</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">deriv_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">stat1</span> <span class="o">-</span> <span class="n">stat0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1e-10</span> <span class="o">+</span> <span class="n">pvalues_deriv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">shift</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">deriv_value</span><span class="p">):</span>
                <span class="n">deriv</span> <span class="o">+=</span> <span class="p">[</span><span class="n">deriv_value</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">deriv</span> <span class="o">+=</span> <span class="p">[</span><span class="mf">1e-5</span><span class="p">]</span>
            <span class="c1"># print(stat0, stat1, deriv)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">current_model</span><span class="p">)</span>
        <span class="n">deriv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">deriv</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">deriv</span>

    <span class="k">def</span> <span class="nf">_stat_deriv_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        To calculate the second derivative matrix of the statistic value.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        deriv_matrix : matrix</span>
<span class="sd">            The calculated matrix.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="mf">1e-4</span>
        <span class="n">pnames_free</span><span class="p">,</span> <span class="n">pvalues_free</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_free_parameter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="n">current_model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="n">deriv_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">pnames_free</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">pnames_free</span><span class="p">)])</span>
        <span class="k">for</span> <span class="n">comb</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pnames_free</span><span class="p">)),</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">stat0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stat_deriv</span><span class="p">(</span><span class="n">pnames</span><span class="o">=</span><span class="p">[</span><span class="n">pnames_free</span><span class="p">[</span><span class="n">comb</span><span class="p">[</span><span class="mi">0</span><span class="p">]]])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">pnames_free</span><span class="p">[</span><span class="n">comb</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                                   <span class="n">pvalues_free</span><span class="p">[</span><span class="n">comb</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">shift</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)</span>
            <span class="n">stat1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stat_deriv</span><span class="p">(</span><span class="n">pnames</span><span class="o">=</span><span class="p">[</span><span class="n">pnames_free</span><span class="p">[</span><span class="n">comb</span><span class="p">[</span><span class="mi">0</span><span class="p">]]])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">current_model</span><span class="p">)</span>
            <span class="n">second_deriv</span> <span class="o">=</span> <span class="p">(</span><span class="n">stat1</span> <span class="o">-</span> <span class="n">stat0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                    <span class="mf">1e-10</span> <span class="o">+</span> <span class="n">pvalues_free</span><span class="p">[</span><span class="n">comb</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">*</span> <span class="n">shift</span><span class="p">)</span>
            <span class="n">deriv_matrix</span><span class="p">[</span><span class="n">comb</span><span class="p">]</span> <span class="o">=</span> <span class="n">second_deriv</span>
        <span class="n">deriv_matrix</span> <span class="o">+=</span> <span class="n">deriv_matrix</span><span class="o">.</span><span class="n">T</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pnames_free</span><span class="p">)):</span>
            <span class="n">stat0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stat_deriv</span><span class="p">(</span><span class="n">pnames</span><span class="o">=</span><span class="p">[</span><span class="n">pnames_free</span><span class="p">[</span><span class="n">i</span><span class="p">]])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">pnames_free</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                   <span class="n">pvalues_free</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">shift</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-10</span><span class="p">)</span>
            <span class="n">stat1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stat_deriv</span><span class="p">(</span><span class="n">pnames</span><span class="o">=</span><span class="p">[</span><span class="n">pnames_free</span><span class="p">[</span><span class="n">i</span><span class="p">]])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">current_model</span><span class="p">)</span>
            <span class="n">second_deriv</span> <span class="o">=</span> <span class="p">(</span><span class="n">stat1</span> <span class="o">-</span> <span class="n">stat0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1e-10</span> <span class="o">+</span> <span class="n">pvalues_free</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">shift</span><span class="p">)</span>
            <span class="n">deriv_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">second_deriv</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mat</span><span class="p">(</span><span class="n">deriv_matrix</span><span class="p">)</span>

    <span class="c1"># def error_estimate_delta_stat(self, param: str, sigma=1, show_step=True):</span>
    <span class="c1">#</span>
    <span class="c1">#     self.model: modeling.Model</span>
    <span class="c1">#     if self._min_stat is None:  # check if self._min_stat exists</span>
    <span class="c1">#         warnings.warn(&quot;Fit the profile first.&quot;)</span>
    <span class="c1">#     elif param not in self.model.param_names:  # check if the model has</span>
    <span class="c1">#         # the parameter</span>
    <span class="c1">#         warnings.warn(f&quot;Parameter &#39;{param}&#39; is not in the model.&quot;)</span>
    <span class="c1">#     elif self.model.fixed[param]:</span>
    <span class="c1">#         warnings.warn(f&quot;Parameter &#39;{param}&#39; is fixed.&quot;)</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         param_value = self.model.__getattribute__(param).value</span>
    <span class="c1">#</span>
    <span class="c1">#         best_model = copy.deepcopy(</span>
    <span class="c1">#             self.model)  # a backup of the best-fit model</span>
    <span class="c1">#</span>
    <span class="c1">#         # solve the function delta-cstat = 1</span>
    <span class="c1">#         self.model.fixed[param] = True</span>
    <span class="c1">#         self.model.bounds[param] = (</span>
    <span class="c1">#             param_value,</span>
    <span class="c1">#             best_model.bounds[param][1])  # constraint lower limit</span>
    <span class="c1">#         init_error = self._error_approx[param] * np.array([1, -1])</span>
    <span class="c1">#         error = []</span>
    <span class="c1">#         for i in range(2):</span>
    <span class="c1">#             root = optimize.root_scalar(self._root_solve_func,</span>
    <span class="c1">#                                         x0=param_value + init_error[</span>
    <span class="c1">#                                             i] * sigma,</span>
    <span class="c1">#                                         args=(</span>
    <span class="c1">#                                             param, sigma ** 2, show_step),</span>
    <span class="c1">#                                         method=&quot;newton&quot;,</span>
    <span class="c1">#                                         fprime=self._root_solve_derivative,</span>
    <span class="c1">#                                         xtol=1e-2)</span>
    <span class="c1">#             print(root)</span>
    <span class="c1">#             error[i] = root[0]</span>
    <span class="c1">#</span>
    <span class="c1">#         self.model = best_model</span>
    <span class="c1">#</span>
    <span class="c1"># def _root_solve_func(self, x, param, dstat, show_step):</span>
    <span class="c1">#</span>
    <span class="c1">#     self.model.__setattr__(param, x)</span>
    <span class="c1">#     stat = self.fit(show_step=False, show_result=False, record_fit=False,</span>
    <span class="c1">#                     tolerance=1e-2)</span>
    <span class="c1">#     if show_step:</span>
    <span class="c1">#         print(</span>
    <span class="c1">#             f&quot;{param} = {x:.2f}; delta C-stat = {stat - self._min_stat:.3e}&quot;)</span>
    <span class="c1">#     return stat - self._min_stat - dstat</span>
    <span class="c1">#</span>
    <span class="c1"># def _root_solve_derivative(self, x, param, dstat, show_step):</span>
    <span class="c1">#     self.model.__setattr__(param, x * (1 + 1e-4))</span>
    <span class="c1">#     stat1 = self.fit(show_step=False, show_result=False, record_fit=False)</span>
    <span class="c1">#     self.model.__setattr__(param, x)</span>
    <span class="c1">#     stat0 = self.fit(show_step=False, show_result=False, record_fit=False)</span>
    <span class="c1">#     return (stat1 - stat0) / (x * 1e-4)</span>

<div class="viewcode-block" id="Profile.mcmc_error"><a class="viewcode-back" href="../../sbfit.html#sbfit.profile.Profile.mcmc_error">[docs]</a>    <span class="k">def</span> <span class="nf">mcmc_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nsteps</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">nwalkers</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">burnin</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        To estimate the errors by using the MCMC method in the emcee package.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nsteps : int, optional</span>
<span class="sd">            The steps of the MCMC chain. The default nsteps = 5000.</span>
<span class="sd">        nwalkers : int, optional</span>
<span class="sd">            The number of MCMC walkers. The default nwalkers = 32.</span>
<span class="sd">        burnin : int, optional</span>
<span class="sd">            The number of steps at the beginning of the chain, which should be</span>
<span class="sd">            discarded when estimating the errors.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        emcee: https://emcee.readthedocs.io/en/stable/</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># a backup of the model.</span>
        <span class="n">model_backup</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="n">stat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">pnames_free</span><span class="p">,</span> <span class="n">pvalues_free</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_free_parameter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pvalues_free</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">nwalkers</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span>
            <span class="n">pvalues_free</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pvalues_free</span><span class="p">)</span>
        <span class="n">sampler</span> <span class="o">=</span> <span class="n">emcee</span><span class="o">.</span><span class="n">EnsembleSampler</span><span class="p">(</span><span class="n">nwalkers</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pvalues_free</span><span class="p">),</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_mcmc_log_probability</span><span class="p">)</span>
        <span class="n">sampler</span><span class="o">.</span><span class="n">run_mcmc</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">nsteps</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="n">skip_initial_state_check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># store sampler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mcmc_sampler</span> <span class="o">=</span> <span class="n">sampler</span>

        <span class="c1"># output error</span>
        <span class="n">flat_samples</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">get_chain</span><span class="p">(</span><span class="n">discard</span><span class="o">=</span><span class="n">burnin</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mcmc_flat_samples</span> <span class="o">=</span> <span class="n">flat_samples</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_error</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

        <span class="n">dof</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_binned_profile</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">pnames_free</span><span class="p">)</span>

        <span class="c1"># try using the mode from the mcmc sample</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pnames_free</span><span class="p">)):</span>
            <span class="n">mode</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_uncertainty</span><span class="p">(</span><span class="n">flat_samples</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">pnames_free</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mode</span><span class="p">)</span>

        <span class="n">new_stat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">update</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_stat</span> <span class="o">&gt;</span> <span class="n">stat</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_model</span><span class="p">(</span><span class="n">model_backup</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stat</span> <span class="o">=</span> <span class="n">new_stat</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pnames_free</span><span class="p">)):</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">up_error</span><span class="p">,</span> <span class="n">low_error</span> <span class="o">=</span> \
                <span class="n">utils</span><span class="o">.</span><span class="n">get_uncertainty</span><span class="p">(</span><span class="n">flat_samples</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span>
                    <span class="n">centroid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">pnames_free</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                                      <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">pnames_free</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="p">(</span><span class="n">up_error</span><span class="p">,</span> <span class="n">low_error</span><span class="p">)})</span>

        <span class="c1"># print fit result</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Degree of freedom: </span><span class="si">{</span><span class="n">dof</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">; C-stat: </span><span class="si">{</span><span class="n">stat</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">pnames_free</span><span class="p">,</span> <span class="n">pvalues_free</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_free_parameter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>

        <span class="p">[</span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pnames_free</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="se">\t</span><span class="si">{</span><span class="n">pvalues_free</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="se">\t</span><span class="s2">&quot;</span>
               <span class="sa">f</span><span class="s2">&quot;+</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">[</span><span class="n">pnames_free</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="se">\t</span><span class="s2">&quot;</span>
               <span class="sa">f</span><span class="s2">&quot;-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_error</span><span class="p">[</span><span class="n">pnames_free</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.3e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>
         <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pnames_free</span><span class="p">))]</span></div>

    <span class="k">def</span> <span class="nf">_mcmc_log_probability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
        <span class="n">pnames_free</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_free_parameter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="n">low_bounds</span><span class="p">,</span> <span class="n">up_bounds</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_parameter_bounds</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                                                           <span class="n">pnames_free</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">up_bounds</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">low_bounds</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">pnames_free</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pnames_free</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">pnames_free</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">theta</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">return</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span><span class="n">update</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>

<div class="viewcode-block" id="Profile.update_mcmc_flat_sample"><a class="viewcode-back" href="../../sbfit.html#sbfit.profile.Profile.update_mcmc_flat_sample">[docs]</a>    <span class="k">def</span> <span class="nf">update_mcmc_flat_sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">burnin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the flat MCMC sample with a new burn-in steps value.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        burnin : int</span>
<span class="sd">            The number of steps at the beginning of the chain, which should be</span>
<span class="sd">            discarded when estimating the errors.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mcmc_sampler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;No sampler found, please run mcmc_error first.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mcmc_sampler</span><span class="o">.</span><span class="n">iteration</span> <span class="o">&lt;=</span> <span class="n">burnin</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Steps of burn-in should be smaller than the number&quot;</span>
                          <span class="s2">&quot;of iterations.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mcmc_flat_samples</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">_mcmc_sampler</span><span class="o">.</span><span class="n">get_chain</span><span class="p">(</span><span class="n">discard</span><span class="o">=</span><span class="n">burnin</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2019-2021, Xiaoyuan Zhang.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>